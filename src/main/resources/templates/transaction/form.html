<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout :: layout(${transaction.id != null ? '编辑交易' : '创建交易'}, ~{::section})}">
<body>
    <section>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 th:text="${transaction.id != null ? '编辑交易' : '创建交易'}"></h2>
            <a th:href="@{/transactions}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> 返回列表
            </a>
        </div>
        
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">交易信息</h5>
            </div>
            <div class="card-body">
                <form th:action="${transaction.id != null ? '/transactions/edit/' + transaction.id : '/transactions/create'}" 
                      th:object="${transaction}" method="post" id="transactionForm">
                    
                    <!-- 隐藏字段 -->
                    <input type="hidden" th:field="*{id}" />
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="type" class="form-label">交易类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="type" th:field="*{type}" required>
                                <option value="">-- 请选择 --</option>
                                <option value="存款">存款</option>
                                <option value="取款">取款</option>
                                <option value="转账">转账</option>
                                <option value="支付">支付</option>
                                <option value="退款">退款</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('type')}" th:errors="*{type}"></div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="amount" class="form-label">金额￥<span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control" id="amount" th:field="*{amount}" 
                                       required min="0" placeholder="请输入金额">
                            </div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('amount')}" th:errors="*{amount}"></div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="transactionTime" class="form-label">交易时间 <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="transactionTime" 
                                   th:field="*{transactionTime}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('transactionTime')}" th:errors="*{transactionTime}"></div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="status" class="form-label">状态 <span class="text-danger">*</span></label>
                            <select class="form-select" id="status" th:field="*{status}" required>
                                <option value="">-- 请选择 --</option>
                                <option value="成功">成功</option>
                                <option value="失败">失败</option>
                                <option value="处理中">处理中</option>
                                <option value="取消">取消</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>
                        </div>
                        
                        <div class="col-12">
                            <label for="description" class="form-label">描述</label>
                            <textarea class="form-control" id="description" th:field="*{description}" 
                                      rows="3" placeholder="请输入交易描述"></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 保存
                        </button>
                        <a th:href="@{/transactions}" class="btn btn-secondary ms-2">
                            <i class="bi bi-x-circle"></i> 取消
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </section>
    
    <!-- 表单校验脚本 -->
    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const transactionTimeField = document.getElementById('transactionTime');
        
        // 从服务器获取当前时间
        fetch('/api/transactions/current-time')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // 服务器返回的时间格式为ISO格式，需要处理成HTML datetime-local需要的格式
                    // ISO格式示例：2025-05-20T14:30:45.123456
                    // 需要的格式：yyyy-MM-ddThh:mm
                    const serverTime = data.data;
                    // 只保留到分钟
                    const formattedTime = serverTime.substring(0, 16);
                    
                    if (transactionTimeField) {
                        transactionTimeField.value = formattedTime;
                    }
                } else {
                    // 如果API调用失败，使用浏览器本地时间
                    setLocalTime();
                }
            })
            .catch(error => {
                console.error('获取服务器时间失败:', error);
                // 如果API调用失败，使用浏览器本地时间
                setLocalTime();
            });
            
        // 使用浏览器本地时间的备用函数    
        function setLocalTime() {
            if (transactionTimeField) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
                transactionTimeField.value = formattedDate;
            }
        }
        
        // 表单校验
        const form = document.getElementById('transactionForm');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
    </script>
</body>
</html> 